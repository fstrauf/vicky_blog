---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';

type Props = CollectionEntry<'recipes'>['data'];

const {
	title,
	description,
	pubDate,
	tags,
	coverImage,
	yield: recipeYield,
	times,
	ingredients,
	instructions,
	nutrition,
} = Astro.props;

const ingredientStrings = (ingredients ?? []).map((ing) => {
	const amountPart = ing.amount ? `${ing.amount} ` : '';
	const unitPart = ing.unit ? `${ing.unit} ` : '';
	const notePart = ing.note ? ` (${ing.note})` : '';
	return `${amountPart}${unitPart}${ing.item}${notePart}`.trim();
});

const jsonLd = {
	'@context': 'https://schema.org',
	'@type': 'Recipe',
	name: title,
	description,
	image: coverImage?.src ? [new URL(coverImage.src, Astro.site).toString()] : undefined,
	datePublished: pubDate instanceof Date ? pubDate.toISOString() : pubDate,
	recipeYield: recipeYield,
	prepTime: times?.prep,
	cookTime: times?.cook,
	totalTime: times?.total,
	recipeIngredient: ingredientStrings.length ? ingredientStrings : undefined,
	recipeInstructions: (instructions ?? []).map((step) => ({
		'@type': 'HowToStep',
		text: step,
	})),
	nutrition: nutrition
		? {
			'@type': 'NutritionInformation',
			calories: nutrition.calories,
			proteinContent: nutrition.protein,
			carbohydrateContent: nutrition.carbs,
			fatContent: nutrition.fat,
			fiberContent: nutrition.fiber,
			sugarContent: nutrition.sugar,
			sodiumContent: nutrition.sodium,
		}
		: undefined,
};
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} image={coverImage?.src} />
		<script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
	</head>
	<body>
		<div class="no-print">
			<Header />
		</div>
		<main class="max-w-4xl mx-auto px-4 py-8">
			<article class="space-y-10">
				{/* Header Section */}
				<header class="text-center space-y-4 max-w-2xl mx-auto">
					<div class="flex items-center justify-center space-x-2 text-sm text-[#81B29A] font-medium tracking-wide">
						<span class="uppercase">Recipe</span>
						<span>&bull;</span>
						<FormattedDate date={pubDate} />
					</div>
					<h1 class="text-4xl md:text-5xl font-serif font-bold text-[#2D2A26] leading-tight text-balance">
						{title}
					</h1>
					<p class="text-lg text-[#5C5855] leading-relaxed">
						{description}
					</p>
					
					{tags?.length ? (
						<div class="flex flex-wrap justify-center gap-2 pt-2">
							{tags.map((tag) => (
								<span class="px-3 py-1 rounded-full bg-[#f4e4dc] text-[#D66D50] text-xs font-bold uppercase tracking-wider">
									{tag}
								</span>
							))}
						</div>
					) : null}
				</header>

				{/* Hero Image */}
				{coverImage?.src ? (
					<div class="rounded-2xl overflow-hidden shadow-lg aspect-video md:aspect-[21/9] relative bg-gray-100">
						<img
							src={coverImage.src}
							alt={coverImage.alt ?? ''}
							width={coverImage.width ?? 1020}
							height={coverImage.height ?? 510}
							class="w-full h-full object-cover"
							loading="eager"
						/>
					</div>
				) : null}

				{/* Quick Stats Bar */}
				<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 p-6 bg-white rounded-xl shadow-sm border border-[#E8E4D9]">
					<div class="text-center border-r border-gray-100 last:border-0 p-2">
						<span class="block text-xs uppercase tracking-widest text-gray-500 font-semibold mb-1">Yields</span>
						<span class="font-serif text-xl font-bold text-[#2D2A26]">{recipeYield ?? '—'}</span>
					</div>
					<div class="text-center border-r border-gray-100 last:border-0 p-2 leading-none">
						<span class="block text-xs uppercase tracking-widest text-gray-500 font-semibold mb-1">Prep Time</span>
						<span class="font-serif text-xl font-bold text-[#2D2A26]">{times?.prep ?? '—'}</span>
					</div>
					<div class="text-center border-r border-gray-100 last:border-0 p-2">
						<span class="block text-xs uppercase tracking-widest text-gray-500 font-semibold mb-1">Cook Time</span>
						<span class="font-serif text-xl font-bold text-[#2D2A26]">{times?.cook ?? '—'}</span>
					</div>
					<div class="text-center p-2">
						<span class="block text-xs uppercase tracking-widest text-gray-500 font-semibold mb-1">Calories</span>
						<span class="font-serif text-xl font-bold text-[#2D2A26]">{nutrition?.calories ? `${nutrition.calories} kcal` : '—'}</span>
					</div>
				</div>

				<div class="grid lg:grid-cols-[1fr_2fr] gap-12 items-start">
					{/* Ingredients Side */}
					<aside class="bg-white p-6 rounded-xl border border-[#E8E4D9] sticky top-8">
						<h2 class="font-serif text-2xl font-bold text-[#2D2A26] mb-6 pb-2 border-b border-[#E8E4D9]">Ingredients</h2>
						<ul class="space-y-3">
							{ingredientStrings.map((line) => (
								<li class="flex items-start text-[#5C5855] leading-relaxed">
									<input type="checkbox" class="mt-1.5 mr-3 accent-[#D66D50] w-4 h-4 rounded-sm border-gray-300 focus:ring-[#D66D50]" />
									<span>{line}</span>
								</li>
							))}
						</ul>

						{nutrition && (
							<div class="mt-8 pt-6 border-t border-dashed border-gray-200">
								<h3 class="text-sm font-bold text-gray-900 mb-3 uppercase tracking-wider">Nutrition per serving</h3>
								<div class="grid grid-cols-2 gap-y-2 text-sm text-gray-600">
									<div class="flex justify-between mr-2"><span>Protein</span> <span class="font-semibold">{nutrition.protein ?? '-'}</span></div>
									<div class="flex justify-between mr-2"><span>Carbs</span> <span class="font-semibold">{nutrition.carbs ?? '-'}</span></div>
									<div class="flex justify-between mr-2"><span>Fat</span> <span class="font-semibold">{nutrition.fat ?? '-'}</span></div>
									<div class="flex justify-between mr-2"><span>Sugar</span> <span class="font-semibold">{nutrition.sugar ?? '-'}</span></div>
								</div>
							</div>
						)}
					</aside>

					{/* Instructions Main */}
					<div class="space-y-8">
						<div class="bg-white p-8 rounded-xl border border-[#E8E4D9] shadow-sm">
							<h2 class="font-serif text-2xl font-bold text-[#2D2A26] mb-6">Instructions</h2>
							<div class="space-y-8">
								{(instructions ?? []).map((step, index) => (
									<div class="group">
										<h3 class="font-serif text-lg font-bold text-[#D66D50] mb-2 flex items-center">
											<span class="flex items-center justify-center w-8 h-8 rounded-full bg-[#fdede8] text-[#D66D50] mr-3 text-base">
												{index + 1}
											</span>
											Step {index + 1}
										</h3>
										<p class="text-[#5C5855] text-lg leading-relaxed pl-11">
											{step}
										</p>
									</div>
								))}
							</div>
						</div>

						{/* Additional Content (rendered markdown) */}
						<div class="prose prose-stone prose-lg max-w-none text-[#5C5855] prose-headings:font-serif prose-headings:text-[#2D2A26] prose-a:text-[#D66D50] hover:prose-a:text-[#81B29A]">
							<slot />
						</div>
					</div>
				</div>

			</article>
		</main>
		<div class="no-print">
			<Footer />
		</div>
	</body>
</html>
