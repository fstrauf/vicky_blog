---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';

type Props = CollectionEntry<'recipes'>['data'];

const {
	title,
	description,
	pubDate,
	tags,
	coverImage,
	yield: recipeYield,
	times,
	ingredients,
	instructions,
	nutrition,
} = Astro.props;

const ingredientStrings = (ingredients ?? []).map((ing) => {
	const amountPart = ing.amount ? `${ing.amount} ` : '';
	const unitPart = ing.unit ? `${ing.unit} ` : '';
	const notePart = ing.note ? ` (${ing.note})` : '';
	return `${amountPart}${unitPart}${ing.item}${notePart}`.trim();
});

const jsonLd = {
	'@context': 'https://schema.org',
	'@type': 'Recipe',
	name: title,
	description,
	image: coverImage?.src ? [new URL(coverImage.src, Astro.site).toString()] : undefined,
	datePublished: pubDate instanceof Date ? pubDate.toISOString() : pubDate,
	recipeYield: recipeYield,
	prepTime: times?.prep,
	cookTime: times?.cook,
	totalTime: times?.total,
	recipeIngredient: ingredientStrings.length ? ingredientStrings : undefined,
	recipeInstructions: (instructions ?? []).map((step) => ({
		'@type': 'HowToStep',
		text: step,
	})),
	nutrition: nutrition
		? {
			'@type': 'NutritionInformation',
			calories: nutrition.calories,
			proteinContent: nutrition.protein,
			carbohydrateContent: nutrition.carbs,
			fatContent: nutrition.fat,
			fiberContent: nutrition.fiber,
			sugarContent: nutrition.sugar,
			sodiumContent: nutrition.sodium,
		}
		: undefined,
};
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} image={coverImage?.src} />
		<script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
	</head>
	<body>
		<div class="no-print">
			<Header />
		</div>
		<main>
			<article class="space-y-8">
				<header class="space-y-4">
					<p class="text-sm text-gray-600">
						<FormattedDate date={pubDate} />
					</p>
					<h1 class="text-3xl font-bold leading-tight">{title}</h1>
					<p class="text-base text-gray-700">{description}</p>
					{tags?.length ? (
						<ul class="flex flex-wrap gap-2 text-sm">
							{tags.map((tag) => (
								<li class="rounded-md bg-gray-100 px-2 py-1 text-gray-700">{tag}</li>
							))}
						</ul>
					) : null}
				</header>

				{coverImage?.src ? (
					<div>
						<img
							src={coverImage.src}
							alt={coverImage.alt ?? ''}
							width={coverImage.width ?? 1020}
							height={coverImage.height ?? 510}
							loading="eager"
							decoding="async"
							class="w-full rounded-xl"
						/>
					</div>
				) : null}

				<section class="grid gap-4 sm:grid-cols-3">
					<div class="rounded-xl border border-gray-200 p-4">
						<h2 class="text-sm font-semibold text-gray-900">Yield</h2>
						<p class="text-sm text-gray-700">{recipeYield ?? '—'}</p>
					</div>
					<div class="rounded-xl border border-gray-200 p-4">
						<h2 class="text-sm font-semibold text-gray-900">Time</h2>
						<ul class="text-sm text-gray-700">
							<li>Prep: {times?.prep ?? '—'}</li>
							<li>Cook: {times?.cook ?? '—'}</li>
							<li>Total: {times?.total ?? '—'}</li>
						</ul>
					</div>
					<div class="rounded-xl border border-gray-200 p-4">
						<h2 class="text-sm font-semibold text-gray-900">Nutrition</h2>
						<ul class="text-sm text-gray-700">
							<li>Calories: {nutrition?.calories ?? '—'}</li>
							<li>Protein: {nutrition?.protein ?? '—'}</li>
							<li>Carbs: {nutrition?.carbs ?? '—'}</li>
							<li>Fat: {nutrition?.fat ?? '—'}</li>
						</ul>
					</div>
				</section>

				<section class="grid gap-8 md:grid-cols-2">
					<div>
						<h2 class="text-xl font-semibold">Ingredients</h2>
						<ul class="mt-3 list-disc space-y-1 pl-5">
							{ingredientStrings.map((line) => (
								<li>{line}</li>
							))}
						</ul>
					</div>
					<div>
						<h2 class="text-xl font-semibold">Instructions</h2>
						<ol class="mt-3 list-decimal space-y-2 pl-5">
							{(instructions ?? []).map((step) => (
								<li>{step}</li>
							))}
						</ol>
					</div>
				</section>

				<section class="prose max-w-none">
					<slot />
				</section>
			</article>
		</main>
		<div class="no-print">
			<Footer />
		</div>
	</body>
</html>
